<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KapanSolat</title>
  <style>
    main {
      max-width: 600px;
      margin: auto;
      text-align: center;
    }
    .capsule {
      font-size:2rem;
      width: 100%;
      margin: 3px;
      padding: 3px;
      border: 3px solid #333;
      border-radius: 15px;
      background-color: green;
      font-weight: bold;
      text-align: center;
    }

    .bg-green { background-color: green; }
    .bg-cyan { background-color: cyan; }
  </style>
  <script src=" https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js "></script>
  <!-- script for debugging on mobile phone
  <script src="//cdn.jsdelivr.net/npm/eruda"></script>
  <script>eruda.init();</script>
  -->
</head>
<body>
  <main>
    <h1>KapanSolat</h1>
    <div id="loader">loading data...</div>
    <div id="content" style="display:none">
      detected location: <span id="location"></span> <br/>
      current date & time: <span id="current_datetime"></span> <br/>
      <div class="capsule bg-cyan">
        <strong id="time_to_next_prayer"></strong> to
        <strong id="next_prayer"></strong> prayer <br/>
      </div>
      prayer times for today:
      <div id="prayer_times" style="padding:1em"></div> <br/>
      <pre id="debug"></pre>
    </div>
  </main>

  <script>
    var DateTime = luxon.DateTime;
    function $(id) { return document.getElementById(id); }

    // fetch prayer times
    // display prayer times
    // determine next prayer time
    // if past isya, exit

    // start counter
      // update countdown
      // if more then 10 minutes, color green
      // if less then 10 minutes, color yellow
      // if less then 0 minutes, color red
      // if less then -10 min, change next prayer time

    var nextPrayer = "", nextPrayerTime = null, prayerTimes = {}
    var timezone = "", currentDate = ''
    var prayerNames = ['Fajr', 'Dhuhr', 'Asr', 'Maghrib', 'Isha']

    var timeToNextPrayerEl = $('time_to_next_prayer')
    var nextPrayerEl = $('next_prayer')
    var timeToNextPrayerEl = $('time_to_next_prayer')
    var currentDatetimeEl = $('current_datetime')

    function calcNextPrayerTime() {
      let now = DateTime.now()
      prayerNames.forEach((v,k) => {
        if (now < v) {
          nextPrayerTime = v
          nextPrayer = k
          return
        }
      })

      // if after isha
      nextPrayer = ''
      nextPrayerTime = prayerTimes['Isha']
    }

    async function fetchPrayerTimes() {
      try {
        let resp = await fetch(window.location.href + "?response-type=json")
        if (resp.ok) {
          let data = await resp.json()

          let loc = data.current_location
          timezone = loc.timezone
          serverCurrentTime = DateTime.fromISO(data.current_time)
          currentDate = serverCurrentTime.toFormat('yyyy-LL-dd')
          //prayerTimes = data.prayer_times;
          prayerNames.map(name => {
            prayerTimes[name] = DateTime.fromSQL(currentDate + " " + data.prayer_times[name], { zone: timezone });
          });
          nextPrayer = data.next_prayer;
          nextPrayerTime = prayerTimes[nextPrayer]

          $('location').innerText = loc.city + ', ' + loc.regionName + ', ' + loc.country

          // $('debug').innerText = JSON.stringify(data.prayer_times, null, 2)
          prayerNames.forEach(name => {
            $("prayer_times").innerHTML += `<div class="capsule bg-green" id="prayer-time-${name}">${name}: ${data.prayer_times[name]}</div>`
          })
        } else {
          $('content').innertext = 'error'
        }
      } catch (e) {
        $('content').innerText = 'error: ' + e.message
      }

      $('loader').style.display = 'none'
      $('content').style.display = 'block'

      // start countdown
      setInterval(updateCountdown, 500);
    }

    function updateCountdown() {
      let now = DateTime.now()
      nextPrayerEl.innerText = nextPrayer
      currentDatetimeEl.innerText = now.toFormat('dd-LL-yyyy hh:mm:ss')

      if (nextPrayer == 'Isha') return;
      let diff = nextPrayerTime.diff(now, 'seconds')

      if (diff < -10) {
        calcNextPrayerTime()
      }

      timeToNextPrayerEl.innerText = diff.toFormat('hh:mm:ss')
    }

    // Alternative to load event. ref: https://developer.mozilla.org/en-US/docs/Web/API/Document/readyState#readystatechange_as_an_alternative_to_load_event
    document.onreadystatechange = () => {
        if (document.readyState === "complete") {
          fetchPrayerTimes();
        }
    };

  </script>
</body>
</html>
